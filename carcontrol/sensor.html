<!DOCTYPE html>
<html>

<head>
  <title>Sensor Data Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@1.0.0"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script type="text/javascript" src="https://cdn.fusioncharts.com/fusioncharts/latest/fusioncharts.js"></script>
  <script type="text/javascript"
    src="https://cdn.fusioncharts.com/fusioncharts/latest/themes/fusioncharts.theme.fusion.js"></script>

  <style>
    .container {
      height: 100%;
      width: 100%;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;

    }

    .custom-row {
      height: 100%;
      width: 100%;
      display: flex;
      flex-direction: row;
      justify-content: center;
      align-items: center;
    }

    .chart-container {
      width: 100%;
      height: 100%;
      border: 2px solid rgb(0, 0, 0);
    }

    canvas {
      width: 100%;
      height: 100%;
    }

    #threeD canvas {
      width: 100vw !important;
      height: 100vh !important;
      position: absolute;
      top: 0;
      left: 0;
    }

    #threeD {
      display: block;
    }
  </style>

</head>

<body>
  <div class="container">
    <div class="custom-row">
      <div class="chart-container">
        <canvas id="distance-chart"></canvas>
      </div>

      <div class="chart-container">
        <canvas id="temp-chart"></canvas>
      </div>
      <div id="ther-container"></div>
    </div>

    <div class="custom-row ">
      <div class="chart-container">
        <canvas id="hmd-chart"></canvas>
      </div>
      <div id="hmd-meter"></div>
      <div class="chart-container">
        <canvas id="threeD"></canvas>
      </div>
    </div>
  </div>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
  <script>
    let xCounter = 1;

    const distanceCtx = document.getElementById('distance-chart').getContext('2d');
    const tempCtx = document.getElementById('temp-chart').getContext('2d');
    const hmdCtx = document.getElementById('hmd-chart').getContext('2d');

    const distanceData = {
      datasets: [{
        label: 'Distance',
        data: [],
        backgroundColor: 'red',
        borderColor: 'red',
        showLine: true,
        fill: false
      }]
    };

    const tempData = {
      datasets: [{
        label: 'Temperature',
        data: [],
        backgroundColor: 'blue',
        borderColor: 'blue',
        showLine: true,
        fill: false
      }]
    };

    const hmdData = {
      datasets: [{
        label: 'Humidity',
        data: [],
        backgroundColor: 'green',
        borderColor: 'green',
        showLine: true,
        fill: false
      }]
    };

    const config = {
      type: 'line',
      data: distanceData,
      options: {
        scales: {
          x: {
            type: 'linear',
            position: 'bottom',
            title: {
              display: true,
              text: 'Time'
            },
            grid: {
              drawOnChartArea: true,
              color: 'rgba(0, 0, 0, 0.1)',
              lineWidth: 1,
              drawTicks: false,
              tickLength: 0
            },
            ticks: {
              stepSize: 1,
              callback: function (value) { return value; },
              precision: 0,
              autoSkip: true,
              maxRotation: 0,
              minRotation: 0
            },
            beginAtZero: true
          },
          y: {
            beginAtZero: true,
            grid: {
              drawOnChartArea: true,
              color: 'rgba(0, 0, 0, 0.1)',
              lineWidth: 1,
              drawTicks: false,
              tickLength: 0
            }
          }
        },
        plugins: {
          zoom: {
            pan: {
              enabled: true,
              mode: 'x'
            },
            zoom: {
              enabled: true,
              mode: 'x'
            }
          }
        }
      }
    };

    const distanceChart = new Chart(distanceCtx, config);
    const tempChart = new Chart(tempCtx, { ...config, data: tempData });
    const hmdChart = new Chart(hmdCtx, { ...config, data: hmdData });

    let ip = '172.18.11.121';
    let tempe = 30, hmd = 30;
    function fetchData(path) {
      fetch(`http://${ip}/${path}`)
        .then(response => response.json())
        .then(data => {
          const currentTime = new Date();
          const timeLabel = `${currentTime.getMinutes()}:${currentTime.getSeconds()}`;
          if (path === 'distance') {
            distanceChart.data.labels.push(timeLabel);
            distanceChart.data.datasets[0].data.push({ x: xCounter, y: data.distance });
            distanceChart.update();
          }
          else if (path === 'temperature') {
            tempChart.data.labels.push(timeLabel);
            tempChart.data.datasets[0].data.push({ x: xCounter, y: data.temperature });
            hmdChart.data.datasets[0].data.push({ x: xCounter, y: data.humidity });
            hmdChart.update();
            tempChart.update();
            tempe = data.temperature;
            hmd = data.humidity;
          }
          console.log(tempe, hmd);
          xCounter++;
        })
        .catch(error => console.error('Error:', error));
    }

    setInterval(() => {
      fetchData('distance');
      fetchData('temperature');
      fetchData('imu');
    }, 1000);

    FusionCharts.ready(function () {
      var chart = new FusionCharts({
        type: 'thermometer',
        renderAt: 'ther-container',
        id: 'myThm',
        width: '5%',
        height: '50%',
        dataFormat: 'json',
        dataSource: {
          "chart": {
            "lowerLimit": "0",
            "upperLimit": "50",
            "numberSuffix": "Â°C",
            "thmFillColor": "#008ee4",
            "showGaugeBorder": "1",
            "gaugeBorderColor": "#008ee4",
            "gaugeBorderThickness": "2",
            "theme": "umber",//fusion
            "showvalue": "1"
          },
          "value": `${tempe}`,
        },
      })
        .render();
    });

    FusionCharts.ready(function () {
      var myChart = new FusionCharts({
        type: "thermometer",
        renderAt: "hmd-meter",
        width: "5%",
        height: "50%",
        dataFormat: "json",
        dataSource: {
          "chart": {
            "lowerLimit": "0",
            "upperLimit": "100",
            "numberSuffix": "%",
            "thmFillColor": "#008ee4",
            "showGaugeBorder": "1",
            "gaugeBorderColor": "#008ee4",
            "gaugeBorderThickness": "2",
            "theme": "umber",
            "showvalue": "1"
          },
          "value": `${hmd}`,

        }
      }).render();
    });
    const canvas = document.getElementById('threeD');

    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0xffffff);
    const camera = new THREE.PerspectiveCamera(75, canvas.clientWidth / canvas.clientHeight, 0.1, 1000);
    const renderer = new THREE.WebGLRenderer({ canvas: canvas });
    renderer.setSize(canvas.clientWidth, canvas.clientHeight);

    const light = new THREE.AmbientLight(0x404040);
    scene.add(light);
    const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
    directionalLight.position.set(5, 5, 5).normalize();
    scene.add(directionalLight);

    let car;

    const loader = new THREE.GLTFLoader();
    loader.load('car1/scene.gltf', function (gltf) {
      car = gltf.scene;
      scene.add(car);
    }, undefined, function (error) {
      console.error(error);
    });

    camera.position.z = 5;

    function fetchThree() {
      return fetch(`http://${ip}/imu`)
        .then(response => response.json())
        .then(data => {
          console.log(data);
          return data;
        })
        .catch(error => console.error('Error fetching data:', error));
    }


    function animate() {
      requestAnimationFrame(animate);
      fetchThree().then(data => {
        if (car) {


          // car.rotation.x = data.ax * 0.175;
          car.rotation.y = data.ay * 0.175;
          // car.glRotatef(data.az * 0.175, 0, 0, 1);
          // car.rotation.z = (data.az - 10) * 0.05;
        }
        renderer.render(scene, camera);
      }).catch(error => {
        console.error('Error fetching data:', error);
      });
    }

    animate();

  </script>
</body>

</html>